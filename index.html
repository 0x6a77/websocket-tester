<!--
/*
 * Copyright (c) 2013 Jeffrey B. Williams
 *
 * Licensed under The Hacker Luv License 1.0.1
 *
 * This license covers the attached intellectual property, created by a hacker who has agreed to share it
 * freely with the world in the hope that others too may enjoy it.
 * You may use this intellectual property as you wish if you agree to these terms:
 *
 * 1. You embrace the pure joy and wonder of discovery.
 * 2. That a hacker is someone who embraces the joy of discovery – full stop, without exception.
 * 3. That discovery is a messy business of false-starts, mistakes, tears, gentle curses,
 *        and that there is no single, i.e. “right,” way to discovery.
 * 4. Accept this property “as-is,” accept that it probably contains errors, and take
 *        full responsibility for any consequences of its use.
 * 5. Retain this license for any derivative works you create with this property.
 *
 * This license embraces the Second Golden Hacker Era (Woz era 2.0).
 * Dale Dougherty of Make Magazine, Nathan Seidle of SparkFun and many others have ushered in this new era,
 * and patiently helped us find our way in Hacker Luv.  We too support this idea of gentle support.
 * Hackers have no need for elitist personalities who see the world top-down, believe there are lesser hackers
 * and send mean emails to people.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING
 * BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE
 * OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
-->

<!DOCTYPE HTML>
<html lang='en'>
<head>
	<meta charset='utf-8'>
	<title>Websocket Server Tester</title>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<meta name='description' content=''>
	<meta name='author' content=''>

	<!-- Le styles -->
	<link href='http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css' rel='stylesheet'>
	<style type='text/css'>
		body {
			padding-top: 40px;
			padding-bottom: 40px;
			background-color: #f5f5f5;
		}

		.form-websocket-data {
			padding: 19px 29px 29px;
			margin: 0 auto 20px;
			background-color: #fff;
			border: 1px solid #e5e5e5;
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
			border-radius: 5px;
			-webkit-box-shadow: 0 1px 2px rgba(0, 0, 0, .05);
			-moz-box-shadow: 0 1px 2px rgba(0, 0, 0, .05);
			box-shadow: 0 1px 2px rgba(0, 0, 0, .05);
		}

		.form-websocket-data .form-websocket-data-heading {
			margin-bottom: 10px;
		}

		.form-websocket-data input[type='text'] {
			font-size: 14px;
			height: auto;
			margin-bottom: 15px;
			padding: 7px 9px;
		}

		.input-block-level {
			margin-top: 10px;
		}

		.messageTable {
			height: 600px;
			overflow: scroll;
		}

		.btn {
			margin-right: 20px;
		}

		.nowrap {
			white-space: nowrap;
		}

	</style>

	<!-- Fav and touch icons -->
	<link rel='apple-touch-icon-precomposed' sizes='144x144' href='../assets/ico/apple-touch-icon-144-precomposed.png'>
	<link rel='apple-touch-icon-precomposed' sizes='114x114' href='../assets/ico/apple-touch-icon-114-precomposed.png'>
	<link rel='apple-touch-icon-precomposed' sizes='72x72' href='../assets/ico/apple-touch-icon-72-precomposed.png'>
	<link rel='apple-touch-icon-precomposed' href='../assets/ico/apple-touch-icon-57-precomposed.png'>
	<link rel='shortcut icon' href='../assets/ico/favicon.png'>

	<script type='text/javascript'>
		var websocket = undefined;

		window.onload = function() {
			recallEntries('servers');
			recallEntries('sentMessages');
		}

		function recallEntries(fieldName) {
			if (hasLocalStorage) {
				var messageList = document.getElementById(fieldName);
				for (var key = 0; key <= 19; key++) {
					if (localStorage[fieldName + key] !== undefined) {
						var value = localStorage[fieldName + key];
						var option = document.createElement('option');
						option.setAttribute('value', value);
						messageList.appendChild(option);
					}
				}
			}
		}

	</script>

</head>

<body>

<div class='container row-fluid'>
	<form class='span12 form-websocket-data' onsubmit='return false'>
		<h3 class='form-websocket-data-heading'>Websocket Server Tester</h3>
		<span class='span3 nowrap'>
			<button id='openButton' class='btn btn-large btn-danger' onclick='websocketToggle()'>Open</button>
			<input id='websocketUrl' type='text' class='input-block-level' placeholder='Websocket Url' list='servers'>
			<datalist id='servers'>
			</datalist>
		</span>
		<br>
		<span class='span11 nowrap'>
			<button id='sendButton' class='btn btn-large btn-primary' disabled='true' onclick='websocketSend()'>Send</button>
			<input id='dataToSend' type='text' class='input-block-level' placeholder='Message data' list='sentMessages'>
			<datalist id='sentMessages'>
			</datalist>
		</span>
	</form>
</div>

<h3 class='span5'>Messages</h3>

<div class='row-fluid messageTable'>
	<table class='table table-striped table-condensed'>
		<thead>
		<tr>
			<th style='width: 20px'>Time</th>
			<th style='width: 10px'>Dir</th>
			<th>Data</th>
		</tr>
		</thead>
		<tbody id='messageTable'>
		</tbody>
	</table>
</div>

<script type='text/javascript'>
	function hasLocalStorage() {
		return typeof(Storage) !== 'undefined';
	}

	function persistEntry(fieldName, entry) {
		if (hasLocalStorage) {

			// Make sure we haven't already persisted this entry.
			var foundEntry = false;
			for (var key = 19; key > 0; key--) {
				if (localStorage[fieldName + (key - 1)] === entry) {
					foundEntry = true;
					break;
				}
			}

			// Now shift the existing items down by one.
			if (foundEntry === false) {
				for (var key = 19; key > 0; key--) {
					if (localStorage[fieldName + (key - 1)] !== undefined) {
						localStorage[fieldName + key] = localStorage[fieldName + (key - 1)];
					}
				}
				localStorage[fieldName + 0] = entry;
			}
		}
	}

	function websocketToggle() {
		if ('WebSocket' in window) {
			var openButton = document.getElementById('openButton');
			var sendButton = document.getElementById('sendButton');
			if (websocket !== undefined) {
				websocket.close();
				websocket = undefined;
				sendButton.disabled = true;
			} else {
				var urlElement = document.getElementById('websocketUrl');
				if (urlElement !== null) {
					var url = urlElement.value;
					websocket = new WebSocket(url);
					displayMessage('Open', url);
					persistEntry('servers', url);

					openButton.className = openButton.className.replace('btn\-danger', 'btn\-success');
					openButton.innerHTML = 'Close';
					sendButton.disabled = false;
				}

				websocket.onmessage = function(event) {
					var message = event.data;
					displayMessage('Recv', message);
				};

				websocket.onclose = function() {
					openButton.className = openButton.className.replace('btn\-success', 'btn\-danger');
					openButton.innerHTML = 'Open';
					websocket = undefined;
					displayMessage('Close', '');
				};
			}
		} else {
			alert('Websocket not supported');
		}
	}

	function websocketSend() {
		if ('WebSocket' in window) {
			var dataField = document.getElementById('dataToSend');
			if (dataField !== null) {
				var message = dataField.value;
				websocket.send(message);
				displayMessage('Sent', message);
				persistEntry('sentMessages', message);
			} else {
				alert('Websocket not supported');
			}
		}
	}

	function displayMessage(direction, message) {
		var tableElement = document.getElementById('messageTable');
		if (tableElement !== null) {
			var now = new Date();
			var newRow = document.createElement('tr');
			var timeStr = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + '.' + now.getMilliseconds();
			newRow.innerHTML = '<td>' + timeStr + '</td><td>' + direction + '</td><td>' + message + '</td>';
			tableElement.appendChild(newRow);
		}
	}
</script>

<script src='http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js'></script>

</body>
<style type='text/css'>

</style>
</html>